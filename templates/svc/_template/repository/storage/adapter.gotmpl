// this file is generated by servgen util based on a template at 2021-06-26 10:37:24 +0300 MSK
package storage

import (
	"context"
	kitCache "github.com/travelata/kit/cache/redis"
	kitStorage "github.com/travelata/kit/db"
	"github.com/travelata/kit/search"
	"github.com/travelata/{{.service.name}}/config"
	"github.com/travelata/{{.service.name}}/domain"
	"github.com/travelata/{{.service.name}}/logger"
	"github.com/travelata/{{.service.name}}/meta"
	"golang.org/x/sync/errgroup"
)

// Adapter provides a contract to access a remote service
type Adapter interface {
	domain.{{Title .service.name}}Storage
	// Init - inits storage adapter
	Init(cfg *config.Storages) error
	// Close
	Close()
}

// container contains all the storages the adapter provides access to
type container struct {
	Db         *kitStorage.Storage
	ReadOnlyDB *kitStorage.Storage
	Cache      *kitCache.Redis
	Search     search.Search
}

// adapterImpl implements storage adapter
type adapterImpl struct {
	container *container
}

// NewAdapter creates a new instance of the adapter
func NewAdapter() Adapter {
	return &adapterImpl{
		container: &container{},
	}
}

func (a *adapterImpl) Init(cfg *config.Storages) error {

	grp, _ := errgroup.WithContext(context.Background())

	// db master
	grp.Go(func() error {
		var err error
		a.container.Db, err = kitStorage.Open(cfg.Database.Master, logger.LF())
		if err != nil {
			return err
		}

		// applying migrations (leader only)
		if meta.Meta.Leader() && cfg.Database.MigPath != "" {
			db, _ := a.container.Db.Instance.DB()
			m := kitStorage.NewMigration(db, cfg.Database.MigPath, logger.LF())
			if err := m.Up(); err != nil {
				return err
			}
		}
		return nil
	})

	// db slave
	if cfg.Database.Slave != nil {
		grp.Go(func() error {
			var err error
			a.container.ReadOnlyDB, err = kitStorage.Open(cfg.Database.Slave, logger.LF())
			return err
		})
	}

	// Redis
	grp.Go(func() error {
		var err error
		a.container.Cache, err = kitCache.Open(cfg.Redis, logger.LF())
		return err
	})

	// Index search
	grp.Go(func() error {
		var err error
		a.container.Search, err = search.NewEs(cfg.Es, logger.LF())
		if err != nil {
			return err
		}
		err = a.ensureSampleIndex()
		if err != nil {
			return err
		}
		return err
	})

	if err := grp.Wait(); err != nil {
		logger.L().E(err).St().Err("init storage")
		return err
	}

	return nil
}

func (a *adapterImpl) Close() {
	a.container.Db.Close()
	a.container.ReadOnlyDB.Close()
	a.container.Cache.Close()
	a.container.Search.Close()
}
